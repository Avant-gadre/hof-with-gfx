#	Various useful scripted effects
#
#	By Rylock and Alpinia
# removes the country in scope from all wars (separately - it won't end the wars)
separate_peace_all_wars = {
	if = {
		limit = {
			has_war = yes
		}
		effect_tooltip = {
			every_enemy_country = {
				limit = {
					NOT = {
						civilwar_target = PREV
					}
				}
				white_peace = PREV
			}
		}
		hidden_effect = {
			# first peace out with faction leaders
			every_enemy_country = {
				limit = {
					is_faction_leader = yes
					NOT = {
						civilwar_target = PREV
					}
				}
				white_peace = PREV
			}
			# then all non-puppets whose faction leaders aren't in the war
			every_enemy_country = {
				limit = {
					is_subject = no
					is_in_faction = yes
					faction_leader = {
						NOT = {
							has_war_with = PREV.PREV
						}
					}
					NOT = {
						civilwar_target = PREV
					}
				}
				white_peace = PREV
			}
			# then all non-puppets who aren't in factions
			every_enemy_country = {
				limit = {
					is_subject = no
					is_in_faction = no
					NOT = {
						civilwar_target = PREV
					}
				}
				white_peace = PREV
			}
			# then all puppets whose overlords aren't in the war
			every_enemy_country = {
				limit = {
					is_subject = yes
					overlord = {
						NOT = {
							has_war_with = PREV.PREV
						}
					}
					NOT = {
						civilwar_target = PREV
					}
				}
				white_peace = PREV
			}
		}
	}
}

# ends puppet status, removes from faction and all current wars (used for rebellions)
clear_all_relations = {
	if = {
		limit = {
			is_subject = yes
		}
		overlord = {
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_free
			}
		}
	}
	else_if = {
		limit = {
			num_subjects > 0
		}
		every_subject_country = {
			overlord = {
				set_autonomy = {
					target = PREV
					autonomy_state = autonomy_free
				}
			}
		}
	}
	if = {
		limit = {
			is_faction_leader = yes
		}
		dismantle_faction = yes
	}
	else_if = {
		limit = {
			is_in_faction = yes
		}
		leave_faction = yes
	}
	separate_peace_all_wars = yes
	every_other_country = {
		diplomatic_relation = {
			country = PREV
			relation = guarantee
			active = no
		}
		diplomatic_relation = {
			country = PREV
			relation = non_aggression_pact
			active = no
		}
		diplomatic_relation = {
			country = PREV
			relation = military_access
			active = no
		}
		diplomatic_relation = {
			country = PREV
			relation = market_access_rights
			active = no
		}
		PREV = {
			diplomatic_relation = {
				country = PREV
				relation = guarantee
				active = no
			}
			diplomatic_relation = {
				country = PREV
				relation = military_access
				active = no
			}
		}
	}
}

# ends puppet status, removes from faction and clears all relations except wars (used for rebellions)
clear_all_relations_except_wars = {
	if = {
		limit = {
			is_subject = yes
		}
		overlord = {
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_free
			}
		}
	}
	if = {
		limit = {
			is_in_faction = yes
		}
		leave_faction = yes
	}
	every_other_country = {
		limit = {
			has_guaranteed = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = guarantee
			active = no
		}
	}
	every_other_country = {
		limit = {
			has_non_aggression_pact_with = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = military_access
			active = no
		}
	}
	every_other_country = {
		limit = {
			has_military_access_to = PREV
		}
		PREV = {
			diplomatic_relation = {
				country = PREV
				relation = military_access
				active = no
			}
		}
	}
	every_other_country = {
		limit = {
			gives_military_access_to = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = military_access
			active = no
		}
	}
}

# clears all relations with PREV (won't remove from faction if not a faction leader, nor stop wars if not a valid target)
clear_relations_with_PREV = {
	if = {
		limit = {
			has_subject = PREV
		}
		set_autonomy = {
			target = PREV
			autonomy_state = autonomy_free
		}
	}
	else_if = {
		limit = {
			is_subject_of = PREV
		}
		PREV = {
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_free
			}
		}
	}
	if = {
		limit = {
			is_in_faction_with = PREV
			OR = {
				is_faction_leader = yes
				PREV = {
					is_faction_leader = yes
				}
			}
		}
		leave_faction = yes
	}
	if = {
		limit = {
			has_war_with = PREV
			is_valid_peace_target = yes
			PREV = {
				is_valid_peace_target = yes
			}
		}
		PREV = {
			save_event_target_as = white_peace_receiver
		}
		white_peace_with_TARGET = yes
	}
	if = {
		limit = {
			has_guaranteed = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = guarantee
			active = no
		}
	}
	else_if = {
		limit = {
			is_guaranteed_by = PREV
		}
		PREV = {
			diplomatic_relation = {
				country = PREV
				relation = guarantee
				active = no
			}
		}
	}
	if = {
		limit = {
			has_non_aggression_pact_with = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = military_access
			active = no
		}
	}
	if = {
		limit = {
			has_military_access_to = PREV
		}
		PREV = {
			diplomatic_relation = {
				country = PREV
				relation = military_access
				active = no
			}
		}
	}
	if = {
		limit = {
			gives_military_access_to = PREV
		}
		diplomatic_relation = {
			country = PREV
			relation = military_access
			active = no
		}
	}
}

# changes the government of the country in scope to that of PREV
copy_popularities_of_PREV = {
	set_politics = {
		ruling_party = var:PREV.current_party_ideology_group
	}
	hidden_effect = {
		set_popularities = {
			democratic = PREV.party_popularity_100@democratic
			neutrality = PREV.party_popularity_100@neutrality
			fascism = PREV.party_popularity_100@fascism
			communism = PREV.party_popularity_100@communism
		}
	}
}

# changes the popularites of the country in scope to that of ROOT (the country running the event)
copy_popularities_of_ROOT = {
	hidden_effect = {
		set_popularities = {
			democratic = ROOT.party_popularity_100@democratic
			neutrality = ROOT.party_popularity_100@neutrality
			fascism = ROOT.party_popularity_100@fascism
			communism = ROOT.party_popularity_100@communism
		}
	}
}

# changes the laws of the country in scope to that of PREV (the country running the event)
copy_laws_of_PREV = {
	hidden_effect = {
		### Economy ###
		if = {
			limit = {
				PREV = {
					has_idea = undisturbed_isolation
				}
			}
			add_ideas = undisturbed_isolation
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = isolation
				}
			}
			add_ideas = isolation
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = civilian_economy
				}
			}
			add_ideas = civilian_economy
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = low_economic_mobilisation
				}
			}
			add_ideas = low_economic_mobilisation
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = partial_economic_mobilisation
				}
			}
			add_ideas = partial_economic_mobilisation
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = war_economy
				}
			}
			add_ideas = war_economy
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = tot_economic_mobilisation
				}
			}
			add_ideas = tot_economic_mobilisation
		}
		### Trade ###
		if = {
			limit = {
				PREV = {
					has_idea = free_trade
				}
			}
			add_ideas = free_trade
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = export_focus
				}
			}
			add_ideas = export_focus
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = limited_exports
				}
			}
			add_ideas = limited_exports
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = closed_economy
				}
			}
			add_ideas = closed_economy
		}
		### Mobilisation ###
		if = {
			limit = {
				PREV = {
					has_idea = disarmed_nation
				}
			}
			add_ideas = disarmed_nation
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = volunteer_only
				}
			}
			add_ideas = volunteer_only
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = limited_conscription
				}
			}
			add_ideas = limited_conscription
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = extensive_conscription
				}
			}
			add_ideas = extensive_conscription
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = service_by_requirement
				}
			}
			add_ideas = service_by_requirement
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = all_adults_serve
				}
			}
			add_ideas = all_adults_serve
		}
		else_if = {
			limit = {
				PREV = {
					has_idea = scraping_the_barrel
				}
			}
			add_ideas = scraping_the_barrel
		}
	}
}

embargo_ROOT = {
	if = {
		limit = {
			NOT = {
				has_country_flag = embargoed_@ROOT
			}
		}
		set_country_flag = embargoed_@ROOT
		ROOT = {
			set_country_flag = embargoed_@PREV
		}
		if = {
			limit = {
				has_dlc = "By Blood Alone"
			}
			if = {
				limit = {
					NOT = {
						is_embargoing = ROOT
					}
				}
				send_embargo = ROOT
			}
			if = {
				limit = {
					NOT = {
						is_embargoed_by = ROOT
					}
				}
				ROOT = {
					send_embargo = PREV
				}
			}
		}
		else = {
			add_opinion_modifier = {
				modifier = embargo
				target = ROOT
			}
			reverse_add_opinion_modifier = {
				modifier = embargo
				target = ROOT
			}
		}
	}
}

embargo_PREV = {
	if = {
		limit = {
			has_dlc = "By Blood Alone"
		}
		if = {
			limit = {
				NOT = {
					is_embargoing = PREV
				}
			}
			send_embargo = PREV
		}
		if = {
			limit = {
				NOT = {
					is_embargoed_by = PREV
				}
			}
			THIS = {
				send_embargo = PREV
			}
		}
	}
	else = {
		add_opinion_modifier = {
			modifier = embargo
			target = PREV
		}
		reverse_add_opinion_modifier = {
			modifier = embargo
			target = PREV
		}
	}
}

clear_embargo_PREV = {
	if = {
		limit = {
			is_embargoing = PREV
		}
		break_embargo = PREV
	}
	if = {
		limit = {
			is_embargoed_by = PREV
		}
		THIS = {
			break_embargo = PREV
		}
	}
	if = {
		limit = {
			has_opinion_modifier = embargo
		}
		remove_opinion_modifier = {
			target = ROOT
			modifier = embargo
		}
	}
}

# scope is the country being freed
remove_puppet_and_leave_faction = {
	if = {
		limit = {
			is_in_faction = yes
		}
		leave_faction = yes
	}
	if = {
		limit = {
			is_subject = yes
		}
		overlord = {
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_free
			}
		}
	}
}

##ROOT to join Other's Faction
ask_to_join_faction = {
	country_event = {
		id = generic_events.10
		hours = 1
	}
}

##Invite Other to join ROOT Faction
invite_country_to_faction = {
	country_event = {
		id = generic_events.18
		hours = 1
	}
}

white_peace_with_ROOT = {
	effect_tooltip = {
		if = {
			limit = {
				NOT = {
					civilwar_target = ROOT
				}
			}
			white_peace = ROOT
		}
	}
	hidden_effect = {
		if = {
			limit = {
				has_war_with = ROOT
				NOT = {
					civilwar_target = ROOT
				}
			}
			if = {
				limit = {
					is_in_faction = yes
					is_faction_leader = no
					faction_leader = {
						has_war_with = ROOT
					}
				}
				set_temp_variable = {
					peace_target1 = faction_leader
				}
			}
			else_if = {
				limit = {
					is_subject = yes
					overlord = {
						has_war_with = ROOT
					}
				}
				set_temp_variable = {
					peace_target1 = overlord
				}
			}
			else = {
				set_temp_variable = {
					peace_target1 = THIS
				}
			}
			ROOT = {
				if = {
					limit = {
						is_in_faction = yes
						is_faction_leader = no
						faction_leader = {
							has_war_with = PREV.PREV
						}
					}
					set_temp_variable = {
						peace_target2 = faction_leader
					}
				}
				else_if = {
					limit = {
						is_subject = yes
						overlord = {
							has_war_with = PREV.PREV
						}
					}
					set_temp_variable = {
						peace_target2 = overlord
					}
				}
				else = {
					set_temp_variable = {
						peace_target2 = THIS
					}
				}
			}
			var:peace_target1 = {
				white_peace = var:peace_target2
			}
			#cleanup in case of war merge bugs
			var:peace_target1 = {
				every_enemy_country = {
					limit = {
						is_ally_with = var:peace_target2
					}
					white_peace = var:peace_target1
				}
			}
			var:peace_target2 = {
				every_enemy_country = {
					limit = {
						is_ally_with = var:peace_target1
					}
					white_peace = var:peace_target2
				}
			}
		}
	}
}

##To From
incoming_war_notification_effect = {
	hidden_effect = {
		country_event = generic_events.30
	}
	#warning event
}

incoming_war_notification_for_ally_effect = {
	every_other_country = {
		limit = {
			is_ally_with = ROOT
		}
		country_event = generic_events.32
	}
}

set_war_flag_effect = {
	set_country_flag = {
		flag = imminent_war
		days = 30
		value = 1
	}
}

incoming_war_all_effect = {
	FROM = {
		incoming_war_notification_effect = yes
	}
	ROOT = {
		incoming_war_notification_for_ally_effect = yes
		set_war_flag_effect = yes
	}
}

### For use in decisions ###
setup_decision_attack_AI = {
	if = {
		limit = {
			has_country_flag = imminent_war
		}
		modify_country_flag = {
			flag = imminent_war
			value = 1
		}
	}
	else = {
		set_country_flag = {
			flag = imminent_war
			value = 1
			days = 50
		}
	}
	hidden_effect = {
		if = {
			limit = {
				FROM = {
					has_civil_war = yes
				}
			}
			every_country_with_original_tag = {
				original_tag_to_check = FROM
				limit = {
					NOT = {
						has_country_flag = preparing_for_war_with_@ROOT
					}
				}
				add_ai_strategy = {
					type = prepare_for_war
					id = ROOT
					value = 100
				}
				set_country_flag = preparing_for_war_with_@ROOT
				ROOT = {
					add_to_array = {
						preparing_for_war_with_@FROM = PREV
					}
					add_ai_strategy = {
						type = prepare_for_war
						id = FROM
						value = 100
					}
				}
				if = {
					limit = {
						is_in_faction = yes						#shouldn't ever happen, but just in case
						is_faction_leader = no
						faction_leader = {
							NOT = {
								has_country_flag = preparing_for_war_with_@ROOT
							}
						}
					}
					faction_leader = {
						add_ai_strategy = {
							type = prepare_for_war
							id = ROOT
							value = 100
						}
						set_country_flag = preparing_for_war_with_@ROOT
						ROOT = {
							add_to_array = {
								preparing_for_war_with_@FROM = PREV
							}
							add_ai_strategy = {
								type = prepare_for_war
								id = PREV
								value = 100
							}
						}
					}
				}
				if = {
					limit = {
						is_subject = yes						#shouldn't ever happen, but just in case
						overlord = {
							NOT = {
								has_country_flag = preparing_for_war_with_@ROOT
							}
						}
					}
					overlord = {
						add_ai_strategy = {
							type = prepare_for_war
							id = ROOT
							value = 100
						}
						set_country_flag = preparing_for_war_with_@ROOT
						ROOT = {
							add_to_array = {
								preparing_for_war_with_@FROM = PREV
							}
							add_ai_strategy = {
								type = prepare_for_war
								id = PREV
								value = 100
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = {
				NOT = {
					FROM = {
						has_country_flag = preparing_for_war_with_@ROOT
					}
				}
			}
			add_to_array = {
				preparing_for_war_with_@FROM = FROM
			}
			add_ai_strategy = {
				type = prepare_for_war
				id = FROM
				value = 100
			}
			FROM = {
				set_country_flag = preparing_for_war_with_@ROOT
				add_ai_strategy = {
					type = prepare_for_war
					id = ROOT
					value = 100
				}
				if = {
					limit = {
						is_in_faction = yes
						is_faction_leader = no
						faction_leader = {
							NOT = {
								has_country_flag = preparing_for_war_with_@ROOT
							}
						}
					}
					faction_leader = {
						add_ai_strategy = {
							type = prepare_for_war
							id = ROOT
							value = 100
						}
						set_country_flag = preparing_for_war_with_@ROOT
						ROOT = {
							add_to_array = {
								preparing_for_war_with_@FROM = PREV
							}
							add_ai_strategy = {
								type = prepare_for_war
								id = PREV
								value = 100
							}
						}
					}
				}
				if = {
					limit = {
						is_subject = yes
						overlord = {
							NOT = {
								has_country_flag = preparing_for_war_with_@ROOT
							}
						}
					}
					overlord = {
						add_ai_strategy = {
							type = prepare_for_war
							id = ROOT
							value = 100
						}
						set_country_flag = preparing_for_war_with_@ROOT
						ROOT = {
							add_to_array = {
								preparing_for_war_with_@FROM = PREV
							}
							add_ai_strategy = {
								type = prepare_for_war
								id = PREV
								value = 100
							}
						}
					}
				}
			}
		}
	}
}

attack_all_effect = {
	incoming_war_notification_for_ally_effect= yes
	setup_decision_attack_AI= yes
}

being_attack_all_effect = {
	incoming_war_notification_effect= yes
	incoming_war_notification_for_ally_effect = yes
	setup_decision_attack_AI = yes
}

clear_decision_attack_AI = {
	if = {
		limit = {
			has_country_flag = {
				flag = imminent_war
				value > 1
			}
		}
		modify_country_flag = {
			flag = imminent_war
			value = -1
		}
	}
	else = {
		clr_country_flag = imminent_war
	}
	hidden_effect = {
		for_each_scope_loop = {
			array = preparing_for_war_with_@FROM
			clr_country_flag = preparing_for_war_with_@ROOT
			add_ai_strategy = {
				type = prepare_for_war
				id = ROOT
				value = -100
			}
			ROOT = {
				add_ai_strategy = {
					type = prepare_for_war
					id = PREV
					value = -100
				}
			}
		}
		clear_array = preparing_for_war_with_@FROM
	}
}
